# (PART) R {-}






# R language



## Tips

- export Excel: `writexl::write_xlsx()`
- `match.arg()`
- `ctrl+l` clear console
- `remotes::package_deps(.packages(T)) %>% tibble::as_tibble()`



### style

- only use `<-` for
  1. function definition
  2. initialize varible, especially when definition is far from first usage (initialize means you create the varible only once)
  3. `foobar(...) <- value`, though it's okay to use `=`, but modifing arguments using function is rare in R, so use `<-` can help you remind what you are doing and be consistency with how the function is defined



### Unnoticed feature

```{r}
as.character(NA) %T>% print %>% class()

as.character(NULL) %T>% print %>% class()
```

```{r}
0xFfE4
```



### Statistics

```r
?e1071::skewness
?e1071::kurtosis

?TukeyHSD
```






## function, evaluation, environment



### core rules

1. lazy evaluation to decide when to evaluate the parameter, 
2. call stack to decide where (start point) to evaluate the argument
3. lexically scoping to where to find undefined symbol in the argument



### lazy evaluation

```{r}
f <- function(x) {y <- 1; message('in f()'); x;}

f(message('evaluate argument'))
```

In `f()`, the parameter `x` is not evaluated until it's used, i.e., after `message('in f()')`.


```{r}
f <- function(x) {message('in f()'); g(x)}
g <- function(x) {message('in g()'); x}

f(message('evaluate argument'))
```

In `f()`, passing the parameter `x` as argument for `g()` doesn't evaluate it.



### call stack

```{r}
f <- function(x) {message('in f()'); g(x)}
g <- function(x) {message('in g()'); y <- 2; x}

y <- 1
f(message('y = ', y))
```

We already know that, `message('y = ', y)` is lazy evaluated after `y <- 2` inside `g()`. Howeverï¼Œwhen the evaluation happens, the stage is NOT the execution env of `g()`. Rather, we start from there, backtrack the call stack,  until we arrive the start point, i.e., the caller env of `f()` (the global env here).



### lexically scoping

```{r}
g <- function(u) (u + v) / 2  
h <- function(u) {
    v <- 1  
    g(u)    
}    
v <- 2  
h(10)
```

Although `g()` is called inside `h()`, it finds `v` in where it's defined, i.e., the global env.

Actually, lexically scoping is not a special rule, and the implemention is rather straightforward. The execution environment's parent is function environment, i.e., when the function is created. So we just need to follow the general rule of parent environment.


### technical details

1. the evaluation of argument happens only once, refer to [here](https://bookdown.dongzhuoer.com/hadley/adv-r/lazy-evaluation.html#promises) 
1. call stack is implemented in that a frame's parent is the previous frame, refer to [here](https://bookdown.dongzhuoer.com/hadley/adv-r/call-stack.html#frames)
1. when you write a function factory, you may need to [force evaluation](https://bookdown.dongzhuoer.com/hadley/adv-r/factory-fundamentals.html#forcing-evaluation)






## install packages



### Bioconductor

If you want use a particular Bioconductor version, say 3.7, `BiocManager::install(version = '3.7')`. 

As a special case, **remotes** allows you specify a certain Bioconductor version when installing packages, like `remotes::install_bioc('3.7/ggtree')`. However, this only works _package-wise_, i,e, if you install other package, it still use the default Bioconductor version ^[At the time of this writing, `remotes::install_bioc('clusterProfiler')` would use Bioconductor 3.8]. 



### Administration and Maintances of R Packages

1. `/usr/lib/R/library` should keep clean, which makes it very convenient to update or reinstall R.
1. `/usr/lib/R/site-library` is useful when there are many users, and they all need many common packages. ^[Another example is a server with Shiny Server installed. There `root` may need some packages for Shiny apps hosted. And the normal user can also use these packages, although he may not need.]
1. `/usr/local/lib/R/site-library` should be removed ^[I get duplicated packages when I use `source("https://install-github.me/username/repo")`].
1. user library, I prefer to use `~/.local/lib/R` ^[add `R_LIBS_USER="~/.local/lib/R"` in `~/.Renviron`], although RStudio's default is `/home/${USER}/R/x86_64-pc-linux-gnu-library/3.4`.






## forcats

```{r message=FALSE}
library(tidyverse)
```

**factors** aims to handle categorical variables, i.e., `factor` class in R.

Here we explain two reordering functions.



### `forcats::fct_reorder(f, x)`   

each level is associated with a `x` value (if multiple, use a function such as `median()` to generate a single value), the order is determined by sorting the corresponding `x` value.

```{r fct-reorder, collapse=TRUE}
with(iris, forcats::fct_reorder(Species, Sepal.Width)) %>% levels

iris %>% group_by(Species) %>% summarise(Sepal.Width = median(Sepal.Width)) %>%
    arrange(Sepal.Width) %>% .$Species %>% as.character()
```

As you can see in following plot, `Species` has been reordered by median of `Sepal.Width`.

```{r fct-reorder-plot, fig.cap='forcats::fct_reorder()'}
cowplot::plot_grid(
    iris %>% 
        ggplot(aes(Species, Sepal.Width)) + geom_boxplot() + 
        labs(title = 'original'),
    iris %>% mutate(Species = forcats::fct_reorder(Species, Sepal.Width)) %>%
        ggplot(aes(Species, Sepal.Width)) + geom_boxplot() + 
        labs(title = 'reorder')
)
```
    


### `forcats::fct_reorder2(f, x, y)`  

Each level is associated with many `x` values and many `y` values, we use a function such as `max()` to select a `x` value, then we can get the corresponding `y` value. Now each level is associated with a single `y` value, and we can determine the order by sorting those `y` values. [^fct-reorder2-plot]

```{r fct-reorder2}
set.seed(0)
chkw <- ChickWeight %>% head(60) %>% mutate_at('Chick', forcats::fct_shuffle)


with(chkw, forcats::fct_reorder2(Chick, Time, weight)) %>% levels()

chkw %>% group_by(Chick) %>% arrange(desc(Time)) %>% slice(1) %>% ungroup() %>% 
    arrange(desc(weight)) %>% .$Chick %>% as.character()
```

As you can see in following plot, the vertical line (max `Time`), `Chick` has been reordered by `weight` at that line.

```{r fct-reorder2-plot, fig.cap='forcats::fct_reorder2()'}
cowplot::plot_grid(
    chkw %>% 
        ggplot(aes(Time, weight, colour = Chick)) + geom_point() + geom_line() + 
        geom_vline(xintercept = 21, alpha = 0.2) + labs(title = 'original'),
    chkw %>% mutate(Chick = forcats::fct_reorder2(Chick, Time, weight)) %>% 
        ggplot(aes(Time, weight, colour = Chick)) + geom_point() + geom_line() + 
        geom_vline(xintercept = 21, alpha = 0.2) + labs(title = 'reorder')
)
```







