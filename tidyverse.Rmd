# tidyverse packages notes

```{r setup, message=FALSE}
library(tidyverse)
```

## forcats

### change factor levels

1. `forcats::fct_reorder(f, x)`   

   each level is associated with a `x` value (if multiple, use a function such as `median()` to generate a single value), the order is determined by sorting the corresponding `x` value. [^fct-reorder-plot]

   ```{r fct-reorder, collapse=TRUE}
   with(iris, forcats::fct_reorder(Species, Sepal.Width)) %>% levels
   
   iris %>% group_by(Species) %>% summarise(Sepal.Width = median(Sepal.Width)) %>%
       arrange(Sepal.Width) %>% .$Species %>% as.character()
   ```

[^fct-reorder-plot]:  
    ```{r fct-reorder-plot, fig.cap='forcats::fct_reorder()'}
    cowplot::plot_grid(
        iris %>% 
            ggplot(aes(Species, Sepal.Width)) + geom_boxplot() + 
            labs(title = 'original'),
        iris %>% mutate(Species = forcats::fct_reorder(Species, Sepal.Width)) %>%
            ggplot(aes(Species, Sepal.Width)) + geom_boxplot() + 
            labs(title = 'reorder')
    )
    ```
    `Species` has been reordered by median of `Sepal.Width`.

2. `forcats::fct_reorder2(f, x, y)`  

   each level is associated with many `x` values and many `y` values, we use a function such as `max()` to select a `x` value, then we can get the corresponding `y` value. Now each level is associated with a single `y` value, and we can determine the order by sorting those `y` values. [^fct-reorder2-plot]

   ```{r fct-reorder2-prepare}
   ```
   
   ```{r fct-reorder2, collapse=TRUE}
   set.seed(0)
   chkw <- ChickWeight %>% head(60) %>% mutate_at('Chick', forcats::fct_shuffle)


   with(chkw, forcats::fct_reorder2(Chick, Time, weight)) %>% levels()
   
   chkw %>% group_by(Chick) %>% arrange(desc(Time)) %>% slice(1) %>% ungroup() %>% 
       arrange(desc(weight)) %>% .$Chick %>% as.character()
   ```

[^fct-reorder2-plot]:  
    ```{r fct-reorder2-plot, fig.cap='forcats::fct_reorder2()'}
    cowplot::plot_grid(
        chkw %>% 
            ggplot(aes(Time, weight, colour = Chick)) + geom_point() + geom_line() + 
            geom_vline(xintercept = 21, alpha = 0.2) + labs(title = 'original'),
        chkw %>% mutate(Chick = forcats::fct_reorder2(Chick, Time, weight)) %>% 
            ggplot(aes(Time, weight, colour = Chick)) + geom_point() + geom_line() + 
            geom_vline(xintercept = 21, alpha = 0.2) + labs(title = 'reorder')
    )
    ```

    Note the vertical line (max `Time`), `Chick` has been reordered by `weight` at that line.


